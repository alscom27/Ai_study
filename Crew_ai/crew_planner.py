# íŒŒì¼ëª… ì˜ˆì‹œ: crew_planner.py

import os
import streamlit as st
from dotenv import load_dotenv
from crewai import Agent, Task, Crew, Process
from langchain.chat_models import ChatOpenAI

# ====================
# 1. ğŸ” API í‚¤ ë¡œë”© (.env)
# ====================
load_dotenv()
openai_key = os.getenv("OPENAI_API_KEY")

if not openai_key:
    st.error("âŒ .envì— OPENAI_API_KEYê°€ ì—†ìŠµë‹ˆë‹¤.")
    st.stop()
else:
    os.environ["OPENAI_API_KEY"] = openai_key

# ====================
# 2. ğŸ¨ Streamlit UI
# ====================
st.set_page_config(page_title="AI ì§„ë¡œ ì½”ì¹˜ & í•™ìŠµ ì±Œë¦°ì§€")
st.title("ğŸ¯ ì§„ë¡œ ì„¤ê³„ + í•™ìŠµ ì±Œë¦°ì§€ ìƒì„±ê¸° (CrewAI ê¸°ë°˜)")

goal = st.text_input("ìµœì¢… ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: AI ê°œë°œì)", value="AI ê°œë°œì")
level = st.selectbox("í˜„ì¬ ìˆ˜ì¤€ì„ ì„ íƒí•˜ì„¸ìš”", ["ì…ë¬¸", "ì¤‘ê¸‰", "ê³ ê¸‰"])
duration = st.slider("ëª©í‘œ ê¸°ê°„ (ê°œì›”)", min_value=1, max_value=12, value=6)
weekly_time = st.slider(
    "ì£¼ê°„ í•™ìŠµ ê°€ëŠ¥ ì‹œê°„ (ì‹œê°„)", min_value=1, max_value=40, value=5
)

if st.button("ğŸš€ í•™ìŠµ ê³„íš ìƒì„±í•˜ê¸°"):

    # ====================
    # 3. ğŸ¤– LLM ì •ì˜ (GPT-4)
    # ====================
    llm = ChatOpenAI(model="gpt-4", temperature=0.5)

    # ====================
    # 4. ğŸ‘¤ Agent ì •ì˜
    # ====================
    # 4-1) Manager Agent: â€œê³„ì¸µ êµ¬ì¡°ëŒ€ë¡œ ì‘ì—…ì„ ë¶„ë°°í•˜ê³  ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ë¼â€
    manager = Agent(
        role="í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €",
        goal=(
            "1) ì§„ë¡œ ë¶„ì„ê°€, ì „ëµ ì„¤ê³„ì, ë‹¨ê¸° ì‹¤í–‰ ì½”ì¹˜, ì±Œë¦°ì§€ ë§ˆìŠ¤í„°ì—ê²Œ ê°ê° "
            "ë‹¨ê³„ë³„ ì—…ë¬´ë¥¼ ë¶„ë°°í•˜ë¼.\n"
            "2) ê° Agentê°€ ë§Œë“¤ì–´ ì¤€ ì¶œë ¥ì„ ê³„ì¸µ êµ¬ì¡°ëŒ€ë¡œ ì •ë¦¬í•˜ì—¬ ìµœì¢… ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ë¼.\n"
            "ëª¨ë“  ê²°ê³¼ë¬¼ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•œë‹¤."
        ),
        backstory="5ë…„ ê²½ë ¥ì˜ ì‹œë‹ˆì–´ PMìœ¼ë¡œ ë³µì¡í•œ í˜‘ì—… ìƒí™©ì„ ì˜ í†µì œí•œë‹¤.",
        verbose=True,
        llm=ChatOpenAI(model="gpt-4", temperature=0.4),
    )

    # 4-2) ê° Agent ì •ì˜
    goal_agent = Agent(
        role="ì§„ë¡œ ë¶„ì„ê°€",
        goal="ì‚¬ìš©ìì˜ ìµœì¢… ëª©í‘œ(ì˜ˆ: AI ê°œë°œì)ë¥¼ ë¶„ì„í•˜ì—¬, í˜„ì¬ ìˆ˜ì¤€ì„ ê³ ë ¤í•´ 3~5ê°œì˜ í•µì‹¬ ì—­ëŸ‰ì„ ë„ì¶œí•œë‹¤.",
        backstory="ì§ì—… ë¶„ì„ ì „ë¬¸ê°€ë¡œ ìˆ˜ë§ì€ ì»¤ë¦¬ì–´ ì„¤ê³„ë¥¼ ë„ì™€ì˜¨ ê²½í—˜ì´ ìˆë‹¤.",
        verbose=True,
        llm=llm,
    )

    mid_agent = Agent(
        role="ì „ëµ ì„¤ê³„ì",
        goal="ì§„ë¡œ ë¶„ì„ê°€ê°€ ë„ì¶œí•œ í•µì‹¬ ì—­ëŸ‰ì„ ë°”íƒ•ìœ¼ë¡œ, ì¤‘ê¸°(3~6ê°œì›”) í•™ìŠµ ë¡œë“œë§µì„ ì„¤ê³„í•œë‹¤.",
        backstory="ì§ë¬´ ê¸°ë°˜ í•™ìŠµ ë¡œë“œë§µì„ ì˜ê²Œ ìª¼ê°œ ì„¤ê³„í•˜ëŠ” ì „ë¬¸ê°€ì´ë‹¤.",
        verbose=True,
        llm=llm,
    )

    short_agent = Agent(
        role="ë‹¨ê¸° ì‹¤í–‰ ì½”ì¹˜",
        goal="ì „ëµ ì„¤ê³„ìê°€ ë§Œë“  ì¤‘ê¸° ë¡œë“œë§µì„ ì£¼ì°¨ë³„ ì‹¤í–‰ ê³„íšìœ¼ë¡œ ì„¸ë¶€ ë¶„í•´í•œë‹¤.",
        backstory="êµ¬ì²´ì ì¸ ì‹¤ì²œ ë‹¨ìœ„ë¡œ ìª¼ê°œì–´ ì‹¤í–‰ì„ ë„ì™€ì£¼ëŠ” ì „ë¬¸ê°€ì´ë‹¤.",
        verbose=True,
        llm=llm,
    )

    challenge_agent = Agent(
        role="í•™ìŠµ ì±Œë¦°ì§€ ë§ˆìŠ¤í„°",
        goal="ë‹¨ê¸° ì‹¤í–‰ ê³„íšì„ ê¸°ë°˜ìœ¼ë¡œ, ê° ì£¼ì°¨ë³„ë¡œ ìˆ˜í–‰í•  â€˜ë„ì „ ê³¼ì œ(ì±Œë¦°ì§€)â€™ë¥¼ ì„¤ê³„í•œë‹¤.",
        backstory="ì§€ë£¨í•œ í•™ìŠµì„ ì¬ë¯¸ìˆëŠ” ì±Œë¦°ì§€ë¡œ ë°”ê¿”ì£¼ëŠ” ë° íŠ¹í™”ëœ AIì´ë‹¤.",
        verbose=True,
        llm=llm,
    )

    # ====================
    # 5. ğŸ§© Task ì •ì˜ (expected_output í¬í•¨)
    # ====================
    task1 = Task(
        agent=goal_agent,
        description=(
            f"1) ìµœì¢… ëª©í‘œ: '{goal}' (í˜„ì¬ ìˆ˜ì¤€: {level})ë¥¼ ê¸°ë°˜ìœ¼ë¡œ\n"
            "2) AI ê°œë°œìë¡œì„œ í•„ìˆ˜ì ì¸ í•µì‹¬ ì—­ëŸ‰ 3~5ê°œë¥¼ ë„ì¶œí•˜ì„¸ìš”."
        ),
        expected_output="í•µì‹¬ ì—­ëŸ‰ ë¦¬ìŠ¤íŠ¸",
    )

    task2 = Task(
        agent=mid_agent,
        description=(
            "1) ì§„ë¡œ ë¶„ì„ê°€ê°€ ì œì‹œí•œ í•µì‹¬ ì—­ëŸ‰ì„ ì…ë ¥ë°›ì•„,\n"
            "2) ê° ì—­ëŸ‰ì„ ê°•í™”í•˜ê¸° ìœ„í•œ ì¤‘ê¸°(3~6ê°œì›”) í•™ìŠµ ë¡œë“œë§µì„ ì„¤ê³„í•˜ì„¸ìš”.\n"
            "   - ê° ëª¨ë“ˆì€ 2~3ë‹¨ê³„ë¡œ ë‚˜ëˆ„ê³  ê°„ë‹¨í•œ ì„¤ëª…ì„ ë§ë¶™ì´ì„¸ìš”."
        ),
        expected_output="ì¤‘ê¸° í•™ìŠµ ë¡œë“œë§µ",
    )

    task3 = Task(
        agent=short_agent,
        description=(
            f"1) ì „ëµ ì„¤ê³„ìê°€ ë§Œë“  ì¤‘ê¸° ë¡œë“œë§µì„ ë°”íƒ•ìœ¼ë¡œ,\n"
            f"2) {duration}ê°œì›”(ì£¼ì°¨ ë‹¨ìœ„) ë™ì•ˆì˜ ì„¸ë¶€ ì‹¤í–‰ ê³„íší‘œë¥¼ ì‘ì„±í•˜ì„¸ìš”.\n"
            f"   - ì£¼ë‹¹ í•™ìŠµ ê°€ëŠ¥ ì‹œê°„: {weekly_time}ì‹œê°„\n"
            "   - ê° ì£¼ì°¨ì— í•´ì•¼ í•  í•™ìŠµ í•­ëª©ê³¼ ì˜ˆìƒ ì†Œìš” ì‹œê°„ì„ ëª…ì‹œí•˜ì„¸ìš”."
        ),
        expected_output="ì£¼ì°¨ë³„ ì‹¤í–‰ ê³„íší‘œ",
    )

    task4 = Task(
        agent=challenge_agent,
        description=(
            "1) ë‹¨ê¸° ì‹¤í–‰ ì½”ì¹˜ê°€ ë§Œë“  ì£¼ì°¨ë³„ ì‹¤í–‰ ê³„íšì„ ì°¸ì¡°í•˜ì—¬,\n"
            "2) ê° ì£¼ì°¨ë§ˆë‹¤ ìˆ˜í–‰í•  ì‹¤ìš©ì ì¸ ë„ì „ ê³¼ì œ(ì±Œë¦°ì§€)ë¥¼ ì„¤ê³„í•˜ì„¸ìš”.\n"
            "   - ê³¼ì œëª…, ì„¤ëª…, ë‚œì´ë„(ì…ë¬¸/ì¤‘ê¸‰/ê³ ê¸‰), ì˜ˆìƒ ì†Œìš” ì‹œê°„ì„ í¬í•¨í•˜ì„¸ìš”."
        ),
        expected_output="ì£¼ì°¨ë³„ í•™ìŠµ ì±Œë¦°ì§€ ë¦¬ìŠ¤íŠ¸",
    )

    # ====================
    # 6. ğŸ¯ Crew ì •ì˜ ë° ì‹¤í–‰
    # ====================
    crew = Crew(
        agents=[goal_agent, mid_agent, short_agent, challenge_agent],
        tasks=[task1, task2, task3, task4],
        process=Process.hierarchical,
        manager_agent=manager,  # âœ… manager_llm ëŒ€ì‹  manager_agent ì‚¬ìš©
        verbose=True,
    )

    # Kickoff: ê° Agentê°€ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  Managerê°€ ìµœì¢… ìš”ì•½
    crew.kickoff()

    # ====================
    # 7. âœ… Agentë³„ ì¶œë ¥(ê³„ì¸µ êµ¬ì¡° ë“œëŸ¬ë‚´ê¸°)
    # ====================
    st.subheader("ğŸ“‚ Agentë³„ / ê³„ì¸µë³„ ê²°ê³¼ë¬¼")

    # 7-1) ì§„ë¡œ ë¶„ì„ê°€ ê²°ê³¼
    st.markdown("### 1ï¸âƒ£ ì§„ë¡œ ë¶„ì„ê°€ (í•µì‹¬ ì—­ëŸ‰ ë„ì¶œ)")
    if task1.output:
        st.markdown(task1.output)
    else:
        st.markdown("_ê²°ê³¼ ì—†ìŒ_")

    # 7-2) ì „ëµ ì„¤ê³„ì ê²°ê³¼
    st.markdown("### 2ï¸âƒ£ ì „ëµ ì„¤ê³„ì (ì¤‘ê¸° í•™ìŠµ ë¡œë“œë§µ)")
    if task2.output:
        st.markdown(task2.output)
    else:
        st.markdown("_ê²°ê³¼ ì—†ìŒ_")

    # 7-3) ë‹¨ê¸° ì‹¤í–‰ ì½”ì¹˜ ê²°ê³¼
    st.markdown("### 3ï¸âƒ£ ë‹¨ê¸° ì‹¤í–‰ ì½”ì¹˜ (ì£¼ì°¨ë³„ ì‹¤í–‰ ê³„íší‘œ)")
    if task3.output:
        st.markdown(task3.output)
    else:
        st.markdown("_ê²°ê³¼ ì—†ìŒ_")

    # 7-4) í•™ìŠµ ì±Œë¦°ì§€ ë§ˆìŠ¤í„° ê²°ê³¼
    st.markdown("### 4ï¸âƒ£ í•™ìŠµ ì±Œë¦°ì§€ ë§ˆìŠ¤í„° (ì£¼ì°¨ë³„ í•™ìŠµ ì±Œë¦°ì§€)")
    if task4.output:
        st.markdown(task4.output)
    else:
        st.markdown("_ê²°ê³¼ ì—†ìŒ_")

    # ====================
    # 8. ğŸ“ Manager ìš”ì•½ (ì „ì²´ ê³„ì¸µ êµ¬ì¡° ë³´ê³ ì„œ)
    # ====================
    st.subheader("ğŸ“‘ í”„ë¡œì íŠ¸ ë§¤ë‹ˆì € ìµœì¢… ë³´ê³ ì„œ")
    # manager_agentê°€ ë§Œë“  ì „ì²´ ìš”ì•½ì€ crew.manager_responseì— ì €ì¥ë©ë‹ˆë‹¤.
    if crew.manager_response:
        st.markdown(crew.manager_response)
    else:
        st.markdown("_Manager ë³´ê³ ì„œ ì—†ìŒ_")
